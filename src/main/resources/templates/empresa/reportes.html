<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reportes Empresariales</title>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/normalize.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .page-wrapper { padding: 30px 5%; max-width: 1400px; margin: 0 auto; }
        
        /* Filtros */
        .filter-bar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        .form-group label { font-size: 0.85rem; font-weight: bold; display:block; margin-bottom:5px; }
        .form-group input { padding: 8px; border: 1px solid #ddd; border-radius: 5px; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: #f1f5f9; cursor: pointer; border-radius: 5px; font-weight: bold; color: #64748b; }
        .tab-btn.active { background: #2563eb; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* Tablas */
        .report-box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo"><a th:href="@{/admin/dashboard}">Tech<span>Admin</span></a></div>
        <div class="nav-menu" id="navMenu">
            <ul class="nav-links">
                <li><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                <li><a th:href="@{/admin/usuarios}">Usuarios</a></li>
                <li><a th:href="@{/admin/inventario}">Inventario</a></li>
                <li><a th:href="@{/admin/servicios}">Servicios</a></li>
                <li><a th:href="@{/admin/mantenimiento}">Mantenimiento</a></li>
                <li><a th:href="@{/admin/reportes}" class="active">Reportes</a></li>
            </ul>
            <div class="auth-buttons">
                <div style="text-align: right; color: white;">
                    <span style="font-weight: bold;" th:text="${session.usuario.nombres}">Admin</span>
                    <small style="display:block; color:#aaa; font-size: 0.75rem;" th:text="${session.usuario.tipoUsuario.nombreRol}">Rol</small>
                </div>
                <a th:href="@{/logout}" class="btn btn-outline" style="border-color: #ef4444; color: #ef4444; padding: 5px 10px;">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
        <div class="burger" id="burgerBtn"><i class="fas fa-bars"></i></div>
    </nav>

    <div class="page-wrapper">
        <h2 style="color: #1e293b;">Centro de Reportes</h2>

        <form class="filter-bar no-print" th:action="@{/admin/reportes}" method="get">
            <div class="form-group">
                <label>Desde</label>
                <input type="date" name="inicio" th:value="${fInicio}" required>
            </div>
            <div class="form-group">
                <label>Hasta</label>
                <input type="date" name="fin" th:value="${fFin}" required>
            </div>
            <button type="submit" class="btn btn-filled"><i class="fas fa-search"></i> Filtrar</button>
            
            <div style="margin-left: auto;">
                <button type="button" onclick="descargarReporte()" class="btn btn-outline"><i class="fas fa-download"></i> Exportar Vista Actual</button>
            </div>
        </form>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('tab-ventas')" 
                    th:if="${rolUsuario != 'CAJERO'}">Ventas Generales</button>
            
            <button class="tab-btn" onclick="openTab('tab-usuarios')" 
                    th:if="${rolUsuario == 'ADMIN_VENDEDOR' or rolUsuario == 'ADMIN'}">Rendimiento Vendedores</button>
            
            <button class="tab-btn" onclick="openTab('tab-caja')" 
                    th:if="${rolUsuario == 'ADMIN_VENDEDOR' or rolUsuario == 'CAJERO' or rolUsuario == 'ADMIN'}">Movimientos de Caja</button>
        </div>

        <div id="tab-ventas" class="tab-content active" th:if="${rolUsuario != 'CAJERO'}">
            <div class="report-box" id="print-ventas">
                <h3 style="color: #2563eb;">Reporte Detallado de Ventas</h3>
                <p>Total Periodo: <strong>S/ <span th:text="${#numbers.formatDecimal(totalVentas, 1, 2)}">0.00</span></strong></p>
                <table>
                    <thead><tr><th>ID</th><th>Fecha</th><th>Cliente</th><th>Comprobante</th><th>Monto</th></tr></thead>
                    <tbody>
                        <tr th:each="v : ${ventas}">
                            <td th:text="${v.idventa}"></td>
                            <td th:text="${#temporals.format(v.fechaventa, 'dd/MM/yyyy HH:mm')}"></td>
                            <td th:text="${v.usuario.nombres}"></td>
                            <td th:text="${v.tipo_comprobante} + ' ' + ${v.num_comprobante}"></td>
                            <td th:text="${#numbers.formatDecimal(v.monto_total, 1, 2)}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-usuarios" class="tab-content" th:if="${rolUsuario == 'ADMIN_VENDEDOR' or rolUsuario == 'ADMIN'}">
            <div class="report-box" id="print-usuarios">
                <h3 style="color: #7c3aed;">Rendimiento por Vendedor</h3>
                <table>
                    <thead><tr><th>Vendedor</th><th>Cant. Ventas</th><th>Total Generado</th></tr></thead>
                    <tbody>
                        <tr th:each="vu : ${ventasPorUsuario}">
                            <td th:text="${vu.get('vendedor')}">Juan</td>
                            <td th:text="${vu.get('cantidad')}">5</td>
                            <td style="font-weight:bold; color: #16a34a;">S/ <span th:text="${#numbers.formatDecimal(vu.get('total'), 1, 2)}">100.00</span></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(ventasPorUsuario)}"><td colspan="3" style="text-align:center;">No hay datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-caja" class="tab-content" th:if="${rolUsuario == 'ADMIN_VENDEDOR' or rolUsuario == 'CAJERO' or rolUsuario == 'ADMIN'}">
            <div class="report-box" id="print-caja">
                <h3 style="color: #059669;">Flujo de Caja</h3>
                <p>Balance Neto: <strong>S/ <span th:text="${#numbers.formatDecimal(balanceCaja, 1, 2)}">0.00</span></strong></p>
                <table>
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Monto</th><th>Método</th></tr></thead>
                    <tbody>
                        <tr th:each="c : ${caja}">
                            <td th:text="${#temporals.format(c.fechaMovimiento, 'dd/MM/yyyy HH:mm')}"></td>
                            <td>
                                <span th:if="${c.tipoMovimiento == 'INGRESO'}" style="color:green; font-weight:bold;">INGRESO</span>
                                <span th:if="${c.tipoMovimiento == 'EGRESO'}" style="color:red; font-weight:bold;">EGRESO</span>
                            </td>
                            <td th:text="${c.concepto}">Venta...</td>
                            <td th:text="${c.monto}">100.00</td>
                            <td th:text="${c.metodoPago}">EFECTIVO</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Lógica de Pestañas
        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            // Marcar botón activo (esto requiere un poco más de lógica para encontrar el botón clickeado, pero visualmente funciona básico)
            event.target.classList.add('active');
        }

        // Descarga Inteligente (Descarga SOLO la pestaña visible)
        function descargarReporte() {
            // Buscar cuál pestaña está activa
            let activeTab = document.querySelector('.tab-content.active');
            let contentId = activeTab.querySelector('.report-box').id; // print-ventas, print-usuarios, etc.
            
            const element = document.getElementById(contentId);
            
            // Usamos html2pdf para simplicidad y mantener estilo
            const opt = {
                margin: 0.5,
                filename: 'Reporte_' + contentId + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>